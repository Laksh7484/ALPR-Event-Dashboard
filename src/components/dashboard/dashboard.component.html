@if (loading() || searching()) {
<app-loader></app-loader>
}
<div class="p-6 lg:p-8 space-y-8">
  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-4">
    <h1 class="text-3xl font-bold text-white">ALPR Event Dashboard</h1>
    <div class="flex items-center gap-4">
      @if (currentUser) {
      <div class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg">
        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <span class="text-sm text-gray-300">{{ currentUser.email }}</span>
      </div>
      <button (click)="logout()"
        class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors duration-200">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        <span class="font-medium">Logout</span>
      </button>
      }
    </div>
  </header>

  <!-- KPIs -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
    @for(kpi of kpis(); track kpi.title) {
    <div
      class="bg-gray-800 border border-gray-700 rounded-xl p-5 flex flex-col justify-between transform hover:-translate-y-1 transition-transform duration-300">
      <div class="flex justify-between items-start">
        <p class="text-gray-400 text-sm font-medium">{{ kpi.title }}</p>
        <div [class]="'p-2 rounded-lg bg-' + kpi.color + '-500/10'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" [class]="'text-' + kpi.color + '-400'" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="kpi.icon" />
          </svg>
        </div>
      </div>
      <div>
        <p class="text-3xl font-bold text-white mt-2">{{ kpi.value }}</p>
      </div>
    </div>
    }
  </section>

  <!-- Filters -->
  <section class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-lg">
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
      <!-- Plate Tag -->
      <div class="flex flex-col space-y-1">
        <label for="plate-tag" class="text-sm font-medium text-gray-400">Plate Tag</label>
        <input id="plate-tag" type="text" placeholder="Search plate..." [value]="plateTagSearch()"
          (input)="onPlateTagChange($event)" (keydown.enter)="searchPlate()"
          class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 placeholder-gray-400" />
      </div>

      <!-- From Date -->
      <div class="flex flex-col space-y-1">
        <label for="from-date" class="text-sm font-medium text-gray-400">From Date</label>
        <div class="relative">
          <input id="from-date" type="date" [value]="dateRangeStart()" (change)="onDateChange('start', $event)"
            class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 text-transparent" />
          <span class="absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-200 text-sm pointer-events-none">
            {{ formattedDateRangeStart() || 'mm-dd-yyyy' }}
          </span>
        </div>
      </div>

      <!-- To Date -->
      <div class="flex flex-col space-y-1">
        <label for="to-date" class="text-sm font-medium text-gray-400">To Date <span class="text-gray-400">(max 90
            days)</span></label>
        <div class="relative">
          <input id="to-date" type="date" [value]="dateRangeEnd()" (change)="onDateChange('end', $event)"
            (click)="onEndDateClick($event)" [max]="getMaxEndDate()" [min]="dateRangeStart()"
            [disabled]="!dateRangeStart()"
            class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed text-transparent" />
          <span class="absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-200 text-sm pointer-events-none">
            {{ formattedDateRangeEnd() || 'mm-dd-yyyy' }}
          </span>
        </div>
      </div>

      <!-- Advanced Filters Dropdown -->
      <div class="flex flex-col space-y-1 relative">
        <label class="text-sm font-medium text-gray-400">More Filters</label>
        <button (click)="toggleAdvancedFilters()"
          class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg hover:bg-gray-600 focus:ring-cyan-500 focus:border-cyan-500 p-2.5 flex items-center justify-between transition-colors">
          <span>Advanced Filters</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform"
            [class.rotate-180]="showAdvancedFilters()" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <!-- Dropdown Menu -->
        @if (showAdvancedFilters()) {
        <div
          class="absolute top-full left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-20 p-4">
          <div class="grid grid-cols-1 gap-4">
            <!-- Camera Name -->
            <div class="flex flex-col space-y-1">
              <label for="dropdown-camera-name" class="text-sm font-medium text-gray-400">Camera Name</label>
              <select id="dropdown-camera-name" [value]="selectedCamera()" (change)="onCameraChange($event)"
                class="bg-gray-800 border border-gray-500 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                @for(camera of uniqueCameraNames(); track camera) {
                <option [value]="camera">{{ formatValue(camera) }}</option>
                }
              </select>
            </div>

            <!-- Vehicle Make -->
            <div class="flex flex-col space-y-1">
              <label for="dropdown-car-make" class="text-sm font-medium text-gray-400">Vehicle Make</label>
              <select id="dropdown-car-make" [value]="selectedCarMake()" (change)="onCarMakeChange($event)"
                class="bg-gray-800 border border-gray-500 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                @for(make of uniqueCarMakes(); track make) {
                <option [value]="make">{{ formatValue(make) }}</option>
                }
              </select>
            </div>
          </div>
        </div>
        }
      </div>

      <!-- Search Button -->
      <button (click)="searchPlate()" [disabled]="searching()" [class.opacity-50]="searching()"
        [class.cursor-not-allowed]="searching()"
        class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 w-full disabled:hover:bg-cyan-600">
        @if (searching()) {
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span>Searching...</span>
        } @else {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <span>Search</span>
        }
      </button>

      <!-- Export CSV Button -->
      <button (click)="exportToCsv()"
        class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 w-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        <span>Export CSV</span>
      </button>
    </div>
  </section>

  <!-- Error Popup Modal -->
  @if (showDateError()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 border border-red-500 rounded-xl p-6 max-w-md mx-4 shadow-2xl">
      <div class="flex items-center gap-3 mb-4">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
            </path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-red-400">Date Selection Error</h3>
      </div>
      <div class="mb-6">
        <p class="text-gray-300 text-sm leading-relaxed">
          {{ dateErrorMessage() }}
        </p>
      </div>
      <div class="flex justify-end">
        <button (click)="closeDateError()"
          class="bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
          OK
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Main Content - Full Width Table -->
  <!-- <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
    <!-- Left Section -->
  <!-- <div class="xl:col-span-3"> -->
  <div>
    <!-- Detections Grid -->
    <section class="bg-gray-800 border border-gray-700 rounded-xl flex flex-col"
      style="height: fit-content; max-height: 1150px;">
      <div class="flex flex-wrap justify-between items-center p-6 border-b border-gray-700 gap-4 flex-shrink-0">
        <div class="flex items-center gap-3">
          <h2 class="text-xl font-semibold text-white">Detection History</h2>
          @if (isSearchMode()) {
          <span class="text-sm text-cyan-400 bg-cyan-400/10 px-3 py-1 rounded-full">
            Search Results
          </span>
          <button (click)="clearSearch()" class="text-sm text-gray-400 hover:text-white transition-colors"
            title="Clear search and return to all detections">
            Clear Search
          </button>
          } @else if (hasActiveFilters()) {
          <span class="text-sm text-green-400 bg-green-400/10 px-3 py-1 rounded-full">
            Filtered Results
          </span>
          <button (click)="clearAllFilters()" class="text-sm text-gray-400 hover:text-white transition-colors"
            title="Clear all filters">
            Clear Filters
          </button>
          }
        </div>
      </div>
      <div class="overflow-x-auto overflow-y-auto" style="max-height: 950px; min-height: 600px;">
        <table class="w-full text-sm text-left text-gray-400">
          <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10 shadow-md">
            <tr>
              <th scope="col" class="px-6 py-3">Plate Tag</th>
              <th scope="col" class="px-6 py-3">Camera</th>
              <th scope="col" class="px-6 py-3">Timestamp</th>
              <th scope="col" class="px-6 py-3">Vehicle Make</th>
              <th scope="col" class="px-6 py-3">Vehicle Type</th>
              <th scope="col" class="px-6 py-3">Vehicle Color</th>
              <th scope="col" class="px-2 py-3">
                <span class="sr-only">Details</span>
              </th>
            </tr>
          </thead>
          <tbody>
            @if (!hasPerformedSearch() && !searching()) {
            <tr>
              <td colspan="7" class="text-center py-12 text-gray-500">
                <div class="flex flex-col items-center gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-600" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <div class="text-center">
                    <p class="text-lg font-medium text-gray-400">No search performed</p>
                    <p class="text-sm text-gray-500 mt-1">Select filters and click search to view detection data</p>
                  </div>
                </div>
              </td>
            </tr>
            } @else if (isSearchMode() && filteredDetections().length === 0 && !searching()) {
            <tr>
              <td colspan="7" class="text-center py-8 text-gray-500">
                No plates found matching "{{ plateTagSearch() }}".
              </td>
            </tr>
            } @else if (filteredDetections().length > 0) { @for(det of
            filteredDetections(); track det.id) {
            <tr (click)="selectDetection(det)"
              class="group border-b border-gray-700 hover:bg-gray-700 transition-colors duration-200 cursor-pointer">
              <td class="px-6 py-4 font-mono font-medium text-white">
                {{ det.plate.tag }}
              </td>
              <td class="px-6 py-4">{{ formatValue(det.source.name) }}</td>
              <td class="px-6 py-4">
                {{
                det.timestamp
                ? formatTimestampToEST(det.timestamp)
                : 'N/A'
                }}
              </td>
              <td class="px-6 py-4">
                {{ formatValue(det.vehicle?.make?.name) }}
              </td>
              <td class="px-6 py-4">
                {{ formatValue(det.vehicle?.type?.name) }}
              </td>
              <td class="px-6 py-4 flex items-center gap-2">
                <span class="w-4 h-4 rounded-full border border-white/20"
                  [style.backgroundColor]="det.vehicle?.color?.code || 'gray'" [class.bg-gray-600]="
                      !det.vehicle?.color?.code ||
                      det.vehicle?.color?.code === 'unknown'
                    "></span>
                <span>{{ formatValue(det.vehicle?.color?.code) }}</span>
              </td>
              <td class="px-2 py-4">
                <svg xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" viewBox="0 0 20 20"
                  fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
                    clip-rule="evenodd" />
                </svg>
              </td>
            </tr>
            } } @else {
            <tr>
              <td colspan="7" class="text-center py-8 text-gray-500">
                No detections found.
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      @if (totalItems().total > 0) {
      <div
        class="flex flex-col sm:flex-row items-center justify-between gap-4 p-6 border-t border-gray-700 flex-shrink-0">
        <div class="flex items-center gap-2 text-sm text-gray-400">
          <span>Showing {{ startItem() }} to {{ endItem() }} of
            {{ totalItems().total }} results</span>
        </div>

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-sm text-gray-400">
            <span>Show</span>
            <select [value]="itemsPerPage()" (change)="onItemsPerPageChange($event)"
              class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 px-2 py-1.5">
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
            <span>entries</span>
          </div>

          <div class="flex items-center gap-2">
            <button (click)="previousPage()" [disabled]="currentPage() === 1" [class.opacity-50]="currentPage() === 1"
              [class.cursor-not-allowed]="currentPage() === 1"
              class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 disabled:hover:bg-gray-700 transition-colors">
              Previous
            </button>

            <button (click)="nextPage()" [disabled]="currentPage() === totalPages()"
              [class.opacity-50]="currentPage() === totalPages()"
              [class.cursor-not-allowed]="currentPage() === totalPages()"
              class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 disabled:hover:bg-gray-700 transition-colors">
              Next
            </button>
          </div>
        </div>
      </div>
      }
    </section>
  </div>
</div>

@if (selectedDetection(); as detection) {
<app-detection-details-modal [detection]="detection" (close)="closeModal()">
</app-detection-details-modal>
}